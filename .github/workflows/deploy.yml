name: Deploy AI Task Assistant

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy-vm:
    name: Build & Deploy to GCP VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build Spring Boot JARs
        run: |
          cd task-service && ./mvnw clean package -DskipTests
          cd ../ai-processor && ./mvnw clean package -DskipTests

      - name: Build React Frontend
        run: |
          cd task-frontend
          npm ci
          npm run build

      - name: Copy Artifacts to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: |
            backend/task-service/target/task-service.jar
            backend/ai-processor/target/ai-processor.jar
            frontend/ai-task-frontend/build/**
          target: /opt/ai-task-assistant/

      - name: Restart VM Services
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo systemctl restart task-service
            sudo systemctl restart ai-processor
            sudo cp -r /opt/ai-task-assistant/task-frontend/build/* /var/www/html/ai-frontend/
            sudo systemctl reload nginx

  # build-and-deploy-gke:
  #   name: Build & Deploy to GKE
  #   runs-on: ubuntu-latest
  #   needs: build-and-deploy-vm

  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v4

  #     - name: Setup gcloud
  #       uses: google-github-actions/setup-gcloud@v2
  #       with:
  #         service_account_key: ${{ secrets.GCP_SA_KEY }}
  #         project_id: ${{ secrets.GCP_PROJECT_ID }}

  #     - name: Configure Docker for Artifact Registry
  #       run: |
  #         gcloud auth configure-docker "${{ secrets.GCP_PROJECT_ID }}-docker.pkg.dev"

  #     - name: Build and Push Docker Images
  #       run: |
  #         docker build -t "${{ secrets.GCP_PROJECT_ID }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ai-task-repo/task-service:latest" ./task-service
  #         docker push "${{ secrets.GCP_PROJECT_ID }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ai-task-repo/task-service:latest"
  #         docker build -t "${{ secrets.GCP_PROJECT_ID }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ai-task-repo/ai-processor:latest" ./ai-processor
  #         docker push "${{ secrets.GCP_PROJECT_ID }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ai-task-repo/ai-processor:latest"

  #     - name: Get GKE Credentials
  #       run: |
  #         gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} --zone ${{ secrets.GKE_ZONE }} --project ${{ secrets.GCP_PROJECT_ID }}

  #     - name: Deploy to GKE
  #       run: |
  #         kubectl apply -f k8s/
  #         kubectl rollout restart deployment/task-service
  #         kubectl rollout restart deployment/ai-processor
